# Docker on Travis requires sudo.
sudo: required

services:
  - docker

install:
  - REPO=gehlenborglab/higlass-server
  - BRANCH=`echo ${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH} | perl -pne 'chomp;s{.*/}{};s/\W/-/g'`
  - TAG=$REPO:$BRANCH
  - echo $TAG
  - docker pull $TAG
  # Once things are stable, pulling latest will speed up builds by filling the layer cache,
  # and it will make builds more reliable, by minimizing the network hits from Travis.
  # TODO: Would something like dev-latest make sense, for even tighter caching?
  - docker build --tag $TAG context

script:
  # "set -e" would abort the Travis run,
  # but we still want after_failure if the last line fails.
  - PORT=8888
  - docker run --name higlass-container --detach --publish $PORT:80 $TAG
  - docker ps -a
  - URL=http://localhost:$PORT/
  - >
      TRY=0;
      until $(curl --output /dev/null --silent --fail --globoff $URL); do
        echo '.';
        (( TRY++ ));
        [[ $TRY -lt 10 ]] || break;
        sleep 1;
      done
  - JSON=`curl $URL`
  - echo $JSON
  - '[ "$JSON" == "{\"tilesets\":\"${URL}tilesets/\"}" ] && echo "PASS"'

after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - >
      [ "$TRAVIS_EVENT_TYPE" == "pull_request" ]
      && docker tag $TAG $REPO:github-`git rev-parse HEAD` $REPO:travis-$TRAVIS_BUILD_ID
      && docker push $REPO
  - >
      [ ! -z "TRAVIS_TAG" ]
      && docker tag $REPO:latest $REPO:$TRAVIS_TAG
      && docker push $REPO

after_failure:
  - docker logs higlass-container